---
title: "Opioid Utilization Exploratory Data Analysis"
author: "Julia Silge"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(cache = TRUE,
                      warning = FALSE, message = FALSE, 
                      dpi = 180)
options(width=80)
library(ggplot2)
library(silgelib)
theme_set(theme_roboto())
```


## Clean and tidy opioid utilization data

Let's open up the dataset and start munging and preparing it.

```{r opioids_raw}
library(tidyverse)
library(readxl)

opioids_raw <- bind_rows(
    1:3 %>% 
        map_df(~ read_excel("./OpiodDispensation_Zip_2014.xlsx", 
                            sheet = .x , skip = 1) %>%
                   mutate(date = as.Date(paste0("2014-", .x + 5, "-01"))) %>%
                   rename(zipcode = `Zip Code`) %>%
                   filter(!is.na(zipcode))) %>%
        mutate(zipcode = as.numeric(zipcode)) %>%
        filter(!is.na(zipcode)),
    read_excel("./OpiodDispensation_Zip_2014.xlsx", 
               sheet = 4, skip = 1) %>%
        mutate(date = as.Date("2014-12-01")) %>%
        rename(zipcode = `Dispensary Postal Code`) %>%
        mutate(zipcode = as.numeric(zipcode)),
    1:12 %>% 
        map_df(~ read_excel("./OpiodDispensation_2015.xlsx", 
                            sheet = .x, skip = 1) %>%
                   mutate(date = as.Date(paste0("2015-", .x, "-01"))) %>%
                   rename(zipcode = `Dispensary Postal Code`) %>%
                   filter(!is.na(zipcode))),
    1:12 %>% 
        map_df(~ read_excel("./OpiodDispensation_2016.xlsx", 
                            sheet = .x, skip = 1) %>%
                   mutate(date = as.Date(paste0("2016-", .x, "-01"))) %>%
                   rename(zipcode = `Zip Code`) %>%
                   filter(!is.na(zipcode))),
    1:2 %>% 
        map_df(~ read_excel("./OpiodDispensation_2017.xlsx", 
                            sheet = .x, skip = 1) %>%
                   mutate(date = as.Date(paste0("2017-", .x, "-01"))) %>%
                   rename(zipcode = `Dispensary Postal Code`) %>%
                   filter(!is.na(zipcode)))) %>%
    rename(total = Totals) 

opioids_raw[is.na(opioids_raw)] <- 0

opioids_raw
```

Let's connect [those zipcodes to counties](http://www2.census.gov/geo/docs/maps-data/data/rel/zcta_county_rel_10.txt). Zipcodes are great, but a bigger unit like counties will be better for mapping purposes.

```{r texas_opioids, dependson="opioids_raw"}
zcta_county <- read_csv("http://www2.census.gov/geo/docs/maps-data/data/rel/zcta_county_rel_10.txt") %>%
    select(ZCTA5, STATE, COUNTY, GEOID) %>%
    filter(STATE == 48)

texas_opioids <- opioids_raw %>% 
    mutate(zipcode = as.character(zipcode)) %>%
    inner_join(zcta_county, by = c("zipcode" = "ZCTA5"))

texas_opioids
```


## Download population in each Texas county from US Census

Let's find the population in each Texas county so we can do some relative comparisons.

```{r population}
library(tidycensus)

population <- get_acs(geography = "county", 
                     variables = "B01003_001", 
                     state = "TX",
                     geometry = TRUE) 

population
```



## Join Census data to opioid data

Next let's join the data from the Census to the opioid utilization data. We will calculate a *rate* of opioid utilization that is the number of total prescriptions divided by the population (per 10,000 people).

```{r opioids_joined, dependson = c("texas_opioids", "population")}
library(sf)

opioids_joined <- texas_opioids %>%
    group_by(GEOID) %>%
    summarise(total = sum(total)) %>%
    ungroup %>%
    inner_join(population %>% 
                      mutate(GEOID = as.integer(GEOID))) %>%
    mutate(opioid_rate = total / estimate * 1e3,
           opioid_rate = ifelse(is.infinite(opioid_rate), NA, opioid_rate)) %>%
    st_as_sf()

opioids_joined
```


```{r}
library(leaflet)
library(stringr)

pal <- colorNumeric(palette = "viridis", domain = log(opioids_joined$opioid_rate))

opioids_joined %>%
    st_transform(crs = "+init=epsg:4326") %>%
    leaflet(width = "100%") %>%
    addProviderTiles(provider = "CartoDB.Positron") %>%
    addPolygons(popup = ~ str_extract(NAME, "^([^,]*)"),
                stroke = FALSE,
                smoothFactor = 0,
                fillOpacity = 0.7,
                color = ~ pal(log(opioid_rate))) %>%
    addLegend("bottomright", 
              pal = pal, 
              values = ~ log(opioid_rate),
              title = "Log of prescriptions\nper 1k population",
              opacity = 1)
```






